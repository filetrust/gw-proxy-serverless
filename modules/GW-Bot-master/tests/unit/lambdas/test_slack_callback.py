from unittest import TestCase

from gw_bot.Deploy import Deploy
from gw_bot.helpers.Test_Helper import Test_Helper
from gw_bot.lambdas.slack_callback import run
from osbot_aws.apis.Lambda import Lambda
from osbot_aws.helpers.Lambda_Package import Lambda_Package
from pbx_gs_python_utils.utils.Dev import Dev



class test_lambda_gs_bot(Test_Helper):

    def setUp(self):
        super().setUp()
        self.lambda_name = 'gw_bot.lambdas.slack_callback'
        self.aws_lambda = Lambda(self.lambda_name)

    def test_lambda_update(self):
        Deploy().deploy_lambda__jira('osbot_jira.lambdas.slack_actions')
        Deploy().deploy_lambda__gw_bot('gw_bot.lambdas.gw_bot')
        Deploy().deploy_lambda__gw_bot(self.lambda_name)


    def test_invoke_directly(self):
        self.result = run({},{})

    def test_invoke_directly__with_payload(self):
        #payload = {'body': 'payload=%7B%22type%22%3A%22block_actions%22%2C%22team%22%3A%7B%22id%22%3A%22TRQU3V52S%22%2C%22domain%22%3A%22glasswall-solutions%22%7D%2C%22user%22%3A%7B%22id%22%3A%22UR9UENEAW%22%2C%22username%22%3A%22dcruz%22%2C%22name%22%3A%22dcruz%22%2C%22team_id%22%3A%22TRQU3V52S%22%7D%2C%22api_app_id%22%3A%22ARQD319T7%22%2C%22token%22%3A%22grIGwKiaF1AYTrgpfyLYwsI2%22%2C%22container%22%3A%7B%22type%22%3A%22message%22%2C%22message_ts%22%3A%221582150879.032000%22%2C%22channel_id%22%3A%22DRE51D4EM%22%2C%22is_ephemeral%22%3Afalse%7D%2C%22trigger_id%22%3A%22960210916117.874955991094.838445fb9a2e4014198166324d36f444%22%2C%22channel%22%3A%7B%22id%22%3A%22DRE51D4EM%22%2C%22name%22%3A%22directmessage%22%7D%2C%22message%22%3A%7B%22type%22%3A%22message%22%2C%22subtype%22%3A%22bot_message%22%2C%22text%22%3A%22This+content+can%27t+be+displayed.%22%2C%22ts%22%3A%221582150879.032000%22%2C%22username%22%3A%22GW-Bot%22%2C%22bot_id%22%3A%22BRCUGDR4K%22%2C%22blocks%22%3A%5B%7B%22type%22%3A%22section%22%2C%22block_id%22%3A%22block_NZVF%22%2C%22text%22%3A%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22%3Apoint_right%3A+%2AIssue%2A%3A+%3Cbcf66c78613e430c99ee866a98d31262.eu-west-1.aws.found.io%5C%2Fbrowse%5C%2FTASK-60%7CTASK-60+-+a+new+test%3E%22%2C%22verbatim%22%3Afalse%7D%7D%2C%7B%22type%22%3A%22section%22%2C%22block_id%22%3A%22block_V4M7%22%2C%22text%22%3A%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22%2AChange+issue+status+to%2A%3A+%28click+to+change%29%22%2C%22verbatim%22%3Afalse%7D%7D%2C%7B%22type%22%3A%22actions%22%2C%22block_id%22%3A%22block_RL98%22%2C%22elements%22%3A%5B%7B%22type%22%3A%22button%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Atransition_to%3A%3A161%22%2C%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22In+Progress%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22TASK-60%3A%3A161%3A%3AIn+Progress%22%7D%2C%7B%22type%22%3A%22button%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Atransition_to%3A%3A11%22%2C%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Start+Progress%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22TASK-60%3A%3A11%3A%3AStart+Progress%22%7D%5D%7D%2C%7B%22type%22%3A%22section%22%2C%22block_id%22%3A%22block_VJQW%22%2C%22text%22%3A%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22%2AEdit+Issue+Field%3A%2A+%28select+to+edit%29%22%2C%22verbatim%22%3Afalse%7D%7D%2C%7B%22type%22%3A%22actions%22%2C%22block_id%22%3A%22block_UBQ7%22%2C%22elements%22%3A%5B%7B%22type%22%3A%22static_select%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Aedit_field%3A%3ATASK-60%3A%3Afield_to_edit%22%2C%22placeholder%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Field+to+edit%22%2C%22emoji%22%3Atrue%7D%2C%22options%22%3A%5B%7B%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Assignee%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22Assignee%22%7D%2C%7B%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Description%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22Description%22%7D%2C%7B%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Labels%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22Labels%22%7D%2C%7B%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Latest+Information%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22Latest+Information%22%7D%2C%7B%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Summary%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22Summary%22%7D%5D%7D%5D%7D%2C%7B%22type%22%3A%22section%22%2C%22block_id%22%3A%22block_Y2GX%22%2C%22text%22%3A%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22%2AActions%2A%22%2C%22verbatim%22%3Afalse%7D%7D%2C%7B%22type%22%3A%22actions%22%2C%22block_id%22%3A%22block_FA4S%22%2C%22elements%22%3A%5B%7B%22type%22%3A%22button%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Aview_links%22%2C%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22View+Links%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22TASK-60%22%7D%2C%7B%22type%22%3A%22button%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Ascreenshot%22%2C%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Screenshot%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22TASK-60%22%7D%2C%7B%22type%22%3A%22button%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Areload_issue%22%2C%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Reload+Issue%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22TASK-60%22%7D%2C%7B%22type%22%3A%22button%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Araw_issue_data%22%2C%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Raw+Issue+Data%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22TASK-60%22%7D%5D%7D%2C%7B%22type%22%3A%22divider%22%2C%22block_id%22%3A%22Rv3Q3%22%7D%2C%7B%22type%22%3A%22context%22%2C%22block_id%22%3A%22block_G72P%22%2C%22elements%22%3A%5B%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Rating%3A+None%22%2C%22verbatim%22%3Afalse%7D%2C%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Priority%3A+Medium%22%2C%22verbatim%22%3Afalse%7D%2C%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Issue+Type%3A+Task%22%2C%22verbatim%22%3Afalse%7D%2C%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Assignee%3A+None%22%2C%22verbatim%22%3Afalse%7D%2C%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Labels%3A+None%22%2C%22verbatim%22%3Afalse%7D%2C%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Creator%3A+None%22%2C%22verbatim%22%3Afalse%7D%2C%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Created%3A+2020-02-19%22%2C%22verbatim%22%3Afalse%7D%2C%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Updated%3A+2020-02-19%22%2C%22verbatim%22%3Afalse%7D%5D%7D%5D%7D%2C%22response_url%22%3A%22https%3A%5C%2F%5C%2Fhooks.slack.com%5C%2Factions%5C%2FTRQU3V52S%5C%2F950066577121%5C%2FukKxwwT56BxTlwaaMFf27y3q%22%2C%22actions%22%3A%5B%7B%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Aview_links%22%2C%22block_id%22%3A%22block_FA4S%22%2C%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22View+Links%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22TASK-60%22%2C%22type%22%3A%22button%22%2C%22action_ts%22%3A%221582150886.304726%22%7D%5D%7D'}
        #payload = {'body': 'payload=%7B%22type%22%3A%22block_actions%22%2C%22team%22%3A%7B%22id%22%3A%22TRQU3V52S%22%2C%22domain%22%3A%22glasswall-solutions%22%7D%2C%22user%22%3A%7B%22id%22%3A%22UR9UENEAW%22%2C%22username%22%3A%22dcruz%22%2C%22name%22%3A%22dcruz%22%2C%22team_id%22%3A%22TRQU3V52S%22%7D%2C%22api_app_id%22%3A%22ARQD319T7%22%2C%22token%22%3A%22grIGwKiaF1AYTrgpfyLYwsI2%22%2C%22container%22%3A%7B%22type%22%3A%22message%22%2C%22message_ts%22%3A%221582152217.035800%22%2C%22channel_id%22%3A%22DRE51D4EM%22%2C%22is_ephemeral%22%3Afalse%7D%2C%22trigger_id%22%3A%22947439811026.874955991094.568da2433c5af94ab19c4dbe3c885cdb%22%2C%22channel%22%3A%7B%22id%22%3A%22DRE51D4EM%22%2C%22name%22%3A%22directmessage%22%7D%2C%22message%22%3A%7B%22type%22%3A%22message%22%2C%22subtype%22%3A%22bot_message%22%2C%22text%22%3A%22This+content+can%27t+be+displayed.%22%2C%22ts%22%3A%221582152217.035800%22%2C%22username%22%3A%22GW-Bot%22%2C%22bot_id%22%3A%22BRCUGDR4K%22%2C%22blocks%22%3A%5B%7B%22type%22%3A%22section%22%2C%22block_id%22%3A%22block_YT2N%22%2C%22text%22%3A%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22%3Apoint_right%3A+%2AIssue%2A%3A+%3Cbcf66c78613e430c99ee866a98d31262.eu-west-1.aws.found.io%5C%2Fbrowse%5C%2FTASK-60%7CTASK-60+-+a+new+test%3E%22%2C%22verbatim%22%3Afalse%7D%7D%2C%7B%22type%22%3A%22section%22%2C%22block_id%22%3A%22block_W0QX%22%2C%22text%22%3A%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22%2AChange+issue+status+to%2A%3A+%28click+to+change%29%22%2C%22verbatim%22%3Afalse%7D%7D%2C%7B%22type%22%3A%22actions%22%2C%22block_id%22%3A%22block_OUEA%22%2C%22elements%22%3A%5B%7B%22type%22%3A%22button%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Atransition_to%3A%3A21%22%2C%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Ready+For+Review%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22TASK-60%3A%3A21%3A%3AReady+For+Review%22%7D%2C%7B%22type%22%3A%22button%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Atransition_to%3A%3A111%22%2C%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Stop+Progress%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22TASK-60%3A%3A111%3A%3AStop+Progress%22%7D%2C%7B%22type%22%3A%22button%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Atransition_to%3A%3A151%22%2C%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Done%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22TASK-60%3A%3A151%3A%3ADone%22%7D%5D%7D%2C%7B%22type%22%3A%22section%22%2C%22block_id%22%3A%22block_GW9G%22%2C%22text%22%3A%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22%2AEdit+Issue+Field%3A%2A+%28select+to+edit%29%22%2C%22verbatim%22%3Afalse%7D%7D%2C%7B%22type%22%3A%22actions%22%2C%22block_id%22%3A%22block_VJOA%22%2C%22elements%22%3A%5B%7B%22type%22%3A%22static_select%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Aedit_field%3A%3ATASK-60%3A%3Afield_to_edit%22%2C%22placeholder%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Field+to+edit%22%2C%22emoji%22%3Atrue%7D%2C%22options%22%3A%5B%7B%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Assignee%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22Assignee%22%7D%2C%7B%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Description%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22Description%22%7D%2C%7B%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Labels%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22Labels%22%7D%2C%7B%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Latest+Information%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22Latest+Information%22%7D%2C%7B%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Summary%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22Summary%22%7D%5D%7D%5D%7D%2C%7B%22type%22%3A%22section%22%2C%22block_id%22%3A%22block_2B48%22%2C%22text%22%3A%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22%2AActions%2A%22%2C%22verbatim%22%3Afalse%7D%7D%2C%7B%22type%22%3A%22actions%22%2C%22block_id%22%3A%22block_C5Q7%22%2C%22elements%22%3A%5B%7B%22type%22%3A%22button%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Aview_links%22%2C%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22View+Links%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22TASK-60%22%7D%2C%7B%22type%22%3A%22button%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Ascreenshot%22%2C%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Screenshot%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22TASK-60%22%7D%2C%7B%22type%22%3A%22button%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Areload_issue%22%2C%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Reload+Issue%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22TASK-60%22%7D%2C%7B%22type%22%3A%22button%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Araw_issue_data%22%2C%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Raw+Issue+Data%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22TASK-60%22%7D%5D%7D%2C%7B%22type%22%3A%22divider%22%2C%22block_id%22%3A%22ziFZ%22%7D%2C%7B%22type%22%3A%22context%22%2C%22block_id%22%3A%22block_XKN0%22%2C%22elements%22%3A%5B%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Rating%3A+None%22%2C%22verbatim%22%3Afalse%7D%2C%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Priority%3A+Medium%22%2C%22verbatim%22%3Afalse%7D%2C%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Issue+Type%3A+Task%22%2C%22verbatim%22%3Afalse%7D%2C%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Assignee%3A+None%22%2C%22verbatim%22%3Afalse%7D%2C%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Labels%3A+None%22%2C%22verbatim%22%3Afalse%7D%2C%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Creator%3A+None%22%2C%22verbatim%22%3Afalse%7D%2C%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Created%3A+2020-02-19%22%2C%22verbatim%22%3Afalse%7D%2C%7B%22type%22%3A%22mrkdwn%22%2C%22text%22%3A%22Updated%3A+2020-02-19%22%2C%22verbatim%22%3Afalse%7D%5D%7D%5D%7D%2C%22response_url%22%3A%22https%3A%5C%2F%5C%2Fhooks.slack.com%5C%2Factions%5C%2FTRQU3V52S%5C%2F962437095158%5C%2FMQrgn7uTq1VIKcu4PJtqVEe4%22%2C%22actions%22%3A%5B%7B%22type%22%3A%22static_select%22%2C%22action_id%22%3A%22class_method%3A%3AJira_View_Issue%3A%3Aedit_field%3A%3ATASK-60%3A%3Afield_to_edit%22%2C%22block_id%22%3A%22block_VJOA%22%2C%22selected_option%22%3A%7B%22text%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Description%22%2C%22emoji%22%3Atrue%7D%2C%22value%22%3A%22Description%22%7D%2C%22placeholder%22%3A%7B%22type%22%3A%22plain_text%22%2C%22text%22%3A%22Field+to+edit%22%2C%22emoji%22%3Atrue%7D%2C%22action_ts%22%3A%221582152400.262464%22%7D%5D%7D'}
        payload = {'body': 'payload=%7B%22type%22%3A%22dialog_submission%22%2C%22token%22%3A%22grIGwKiaF1AYTrgpfyLYwsI2%22%2C%22action_ts%22%3A%221582153511.343061%22%2C%22team%22%3A%7B%22id%22%3A%22TRQU3V52S%22%2C%22domain%22%3A%22glasswall-solutions%22%7D%2C%22user%22%3A%7B%22id%22%3A%22UR9UENEAW%22%2C%22name%22%3A%22dcruz%22%7D%2C%22channel%22%3A%7B%22id%22%3A%22DRE51D4EM%22%2C%22name%22%3A%22directmessage%22%7D%2C%22submission%22%3A%7B%22TASK-60%3A%3ASummary%22%3A%22a+new+testAAAAAAAAAA%22%7D%2C%22callback_id%22%3A%22jira_edit_issue%22%2C%22response_url%22%3A%22https%3A%5C%2F%5C%2Fhooks.slack.com%5C%2Fapp%5C%2FTRQU3V52S%5C%2F950128493681%5C%2FPvzySbviprciuHfLJFFZN8jJ%22%2C%22state%22%3A%22%22%7D'}
        self.result = run(payload,{})

    def test_invoke_lambda(self):
        self.test_lambda_update()
        self.result = self.aws_lambda.invoke()
        #assert response == '500 Error'


    def test__create_button_to_test_dialog(self):
        self.test_lambda_update()
        from pbx_gs_python_utils.utils.Lambdas_Helpers import slack_message
        from pbx_gs_python_utils.utils.slack.API_Slack_Attachment import API_Slack_Attachment
        self.api_attach = API_Slack_Attachment()
        self.api_attach.set_text       ('Click on button below to test dialog'          )   \
                       .set_callback_id("button-dialog-test"                            )   \
                       .add_button     ("button 1", "click-me-1", "open 1", "primary"   )   \
                       .add_button     ("button 2", "click-me-2", "open 2", "primary"   )
        attachments = self.api_attach.render()

        slack_message("one message", attachments, 'DDKUZTK6X')